---
- name: Ensure SELinux is set to permissive mode
  become: yes
  lineinfile:
    path: /etc/selinux/config
    regexp: "^SELINUX="
    line: SELINUX=permissive

- include: packages.yml

- include: ssh.yml

- include: postman.yml

- include: jetbrains.yml

- name: Update dotfiles symlinks
  file:
    src: ~/dotfiles/home/{{ item }}
    dest: ~/{{ item }}
    state: link
    # If something already exits, keep it.
    force: no
  with_items:
    - .vimrc
    - .bash_profile
    - .gitconfig
    - .tmux.conf
    - .ssh/config
    - .config/liquidpromptrc
    - .gnupg/gpg.conf

- name: Template git config
  template:
    src: templates/git_user.j2
    dest: ~/.git_user
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
    mode: "0644"

- name: Clone liquid-prompt and make sure it is up to date
  git:
    repo: "https://github.com/nojhan/liquidprompt.git"
    dest: ~/.liquid_prompt
    clone: yes
    update: yes

- name: Ensure ble.sh directory exists
  file:
    path: ~/.blesh
    state: directory
    mode: "0755"

- name: Download ble.sh
  unarchive:
    src: "https://github.com/akinomyoga/ble.sh/releases/download/v{{ ble_version }}/ble-{{ ble_version }}.tar.xz"
    dest: ~/.blesh/
    remote_src: yes

- name: Ensure that .bashrc load custom scripts
  blockinfile:
    path: ~/.bashrc
    block: |
      test -z "$TMUX" && cowsay -f $(cowsay -l | tail -n +2 | xargs | tr " " "\n" | shuf -n 1) $(fortune)
      [[ $- = *i* ]] && source ~/.liquid_prompt/liquidprompt
      for file in $HOME/dotfiles/bashrc.d/*.sh
      do
          source $file
      done
      [[ $- == *i* ]] && source ~/.blesh/ble-{{ ble_version }}/ble.sh --noattach
      ((_ble_bash)) && ble-attach
