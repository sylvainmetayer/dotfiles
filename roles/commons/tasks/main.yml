---
- name: Ensure SELinux is set to permissive mode
  become: yes
  lineinfile:
    path: /etc/selinux/config
    regexp: "^SELINUX="
    line: SELINUX=permissive

- name: Upgrade all packages except kernel
  become: yes
  dnf:
    name: "*"
    state: latest
    exclude:
      - "kernel*"
  tags:
    - network_access

- name: Setup SSH Settings
  block:
    - name: Ensure SSH custom settings folder exists
      file:
        path: ~/.ssh_config
        state: directory
        mode: "0755"
    - name: Copy base host
      copy:
        src: ./templates/base_hosts
        dest: ~/.ssh_config/base_hosts
        owner: "{{ ansible_user_id }}"
        group: "{{ ansible_user_gid }}"
        mode: "0644"
    - name: Create a SSH key
      openssh_keypair:
        path: ~/.ssh/id_user_ed25519
        state: present
        type: ed25519
        force: no
        comment: "{{ ansible_env['USERNAME'] }}@{{ ansible_hostname }}"
      register: ssh_key_status
    - name: "Log new public key for reference"
      when: ssh_key_status.changed
      debug:
        msg: "{{ ssh_key_status.public_key }}"

    - name: Create a SSH key for git
      openssh_keypair:
        path: ~/.ssh/id_git_ed25519
        state: present
        type: ed25519
        force: no
        comment: "{{ ansible_env['USERNAME'] }}@{{ ansible_hostname }} - git"
      register: ssh_key_status_git
    - name: "Log new public key for reference"
      when: ssh_key_status_git.changed
      debug:
        msg: "{{ ssh_key_status_git.public_key }}"

- name: "Import Repositories GPG keys"
  become: yes
  rpm_key:
    state: present
    key: https://packages.microsoft.com/keys/microsoft.asc
  tags:
    - network_access

- name: "Install basic packages"
  become: yes
  dnf:
    name:
      - ansible
      - git
      - make
      - unzip
      - htop
      - wget
      - curl
      - tmux
      - xclip
      - vim
      - firefox
      - rsync
      - gimp
      - vlc
      - fortune-mod
      - cowsay
      - code
      - gnupg2
      - qrencode
      - nextcloud-client
      - keepassxc
      - seahorse
      # Extensions
      # https://github.com/gantsign/ansible-role-visual-studio-code
    state: latest
  tags:
    - network_access

- name: Update dotfiles symlinks
  file:
    src: ~/dotfiles/home/{{ item }}
    dest: ~/{{ item }}
    state: link
    # If something already exits, keep it.
    force: no
  with_items:
    - .vimrc
    - .bash_profile
    - .gitconfig
    - .tmux.conf
    - .ssh/config
    - .config/liquidpromptrc
    - .gnupg/gpg.conf

- name: Template git config
  template:
    src: templates/git_user.j2
    dest: ~/.git_user
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
    mode: "0644"

- name: Clone liquid-prompt and make sure it is up to date
  git:
    repo: "https://github.com/nojhan/liquidprompt.git"
    dest: ~/.liquid_prompt
    clone: yes
    update: yes

- name: Ensure ble.sh directory exists
  file:
    path: ~/.blesh
    state: directory
    mode: "0755"

- name: Download ble.sh
  unarchive:
    src: "https://github.com/akinomyoga/ble.sh/releases/download/v{{ ble_version }}/ble-{{ ble_version }}.tar.xz"
    dest: ~/.blesh/
    remote_src: yes

- name: Ensure that .bashrc load custom scripts
  blockinfile:
    path: ~/.bashrc
    block: |
      test -z "$TMUX" && cowsay -f $(cowsay -l | tail -n +2 | xargs | tr " " "\n" | shuf -n 1) $(fortune)
      [[ $- = *i* ]] && source ~/.liquid_prompt/liquidprompt
      for file in $HOME/dotfiles/bashrc.d/*.sh
      do
          source $file
      done
      [[ $- == *i* ]] && source ~/.blesh/ble-{{ ble_version }}/ble.sh --noattach
      ((_ble_bash)) && ble-attach
