---
- name: Ensure SELinux is set to permissive mode
  become: yes
  lineinfile:
    path: /etc/selinux/config
    regexp: '^SELINUX='
    line: SELINUX=permissive

- name: Update hostname
  hostname:
    name: '{{ host_hostname }}'
  when: host_hostname is defined

- include: packages.yml

- include: ssh.yml

- include: kDrive.yml

- include: jetbrains.yml

- name: Ensure directories exists
  file:
    path: '~/{{ item }}/'
    state: directory
    mode: '0700'
  with_items:
    - .config
    - .gnupg

- name: Update dotfiles symlinks
  file:
    src: ~/dotfiles/home/{{ item }}
    dest: ~/{{ item }}
    state: link
    # If something already exits, keep it.
    force: no
  with_items:
    - .vimrc
    - .bash_profile
    - .bash_aliases
    - .gitconfig
    - .tmux.conf
    - .config/liquidpromptrc
    - .gnupg/gpg.conf

- name: Template git config
  template:
    src: templates/git_user.j2
    dest: ~/.git_user
    owner: '{{ ansible_user_id }}'
    group: '{{ ansible_user_gid }}'
    mode: '0644'

- name: Clone liquid-prompt and make sure it is up to date
  git:
    repo: 'https://github.com/nojhan/liquidprompt.git'
    dest: ~/.liquid_prompt
    clone: yes
    update: yes

- name: Ensure ble.sh directory exists
  file:
    path: ~/.blesh
    state: directory
    mode: '0755'

- name: Download ble.sh
  unarchive:
    mode: 0755
    src: 'https://github.com/akinomyoga/ble.sh/releases/download/v{{ ble_version }}/ble-{{ ble_version }}.tar.xz'
    dest: ~/.blesh/
    remote_src: yes

- name: Ensure local bin directory exists
  file:
    path: '~/.local/bin'
    state: directory
    mode: '0755'

- name: Ensure that .bashrc load custom scripts
  blockinfile:
    path: ~/.bashrc
    block: |
      # User specific environment
      if ! [[ "$PATH" =~ "$HOME/.local/bin:$HOME/bin:" ]]
      then
          PATH="$HOME/.local/bin:$HOME/bin:$PATH"
      fi
      export PATH
      # [[ $- = *i* ]] && source ~/.liquid_prompt/liquidprompt
      for file in ~/dotfiles/bashrc.d/*.sh
      do
          source $file
      done
      # [[ $- == *i* ]] && source ~/.blesh/ble-{{ ble_version }}/ble.sh --noattach
      # ((_ble_bash)) && ble-attach
      if [ -f ~/.bash_aliases ]; then
        . ~/.bash_aliases
      fi
      [[ $- == *i* ]] && eval "$(starship init bash)"
