---
- name: Install requirements
  become: true
  apt:
    name:
      - python3-dev
      - python3-pip
      - libssl-dev
      - openssl
      - libacl1-dev
      - libfuse-dev
      - libacl1
      - build-essential
      - dbus-user-session
    state: present

- name: Install borgmatic requirements
  become: true
  pip:
    name:
      - setuptools
      - wheel
    executable: pip3
    extra_args: "--user --upgrade"

- name: Install Borgmatic
  become: true
  pip:
    name:
      - borgbackup
      - borgmatic
      - borgbackup[fuse]
    executable: pip3
    extra_args: "--user --upgrade"

- name: Ensure sudoers can run borgmatic
  become: true
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    state: present
    regexp: "^Defaults\tsecure_path"
    line: "Defaults\tsecure_path=\"/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/root/.local/bin\""
    validate: /usr/sbin/visudo -cf %s

- name: Ensure root folders allow traversing
  become: true
  file:
    path: "{{ item }}"
    state: directory
    mode: "0711"
  with_items:
    - /root
    - /root/.local

- name: Ensure borgmatic.d folder exists
  become: true
  file:
    path: /etc/borgmatic.d
    state: directory
    mode: "0700"

- name: Template external hard drive backup
  become: true
  template:
    src: templates/external-backup-borg.yaml.j2
    dest: /etc/borgmatic.d/external-backup-borg.yaml
    owner: root
    group: root
    mode: "0600"
    validate: /root/.local/bin/validate-borgmatic-config -c %s

- name: Ensure root has SSH key.
  become: true
  user:
    name: root
    generate_ssh_key: true
    ssh_key_file: .ssh/id_ed25519
    ssh_key_type: ed25519
  register: root_user

- name: Ouput root public SSH key
  debug:
    var: "root_user['ssh_public_key']"

- name: Copy backup script
  become: true
  copy:
    src: "{{ role_path }}/files/backup.sh"
    dest: "/root/backup.sh"
    owner: "root"
    group: "root"
    mode: "0700"

- name: Setup cronjob
  become: true
  ansible.builtin.cron:
    name: "Run borgmatic"
    minute: "0"
    hour: "5"
    job: "/root/backup.sh"

- name: Ensure backup folder exists
  become: true
  file:
    path: "/backup"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0755"

- name: Mount external backup hard drive
  become: true
  mount:
    path: /backup
    src: "UUID={{ backup_hard_drive_uuid }}"
    fstype: ntfs
    opts: auto,nofail,noatime,rw,user
    state: present
