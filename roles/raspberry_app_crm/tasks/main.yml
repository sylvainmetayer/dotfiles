---
# For now, we only configure nginx, certificate and backup script here.
# we will use docker-compose to deploy app

- name: Ensure CRM app folder exists
  file:
    mode: "0700"
    path: "{{ crm_app.base_path }}"
    state: directory

- name: Copy docker-compose configuration
  copy:
    src: "{{ role_path }}/files/docker-compose.yml"
    dest: "{{ crm_app.base_path }}/"
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
    mode: "0644"

- name: Template environment file
  template:
    src: templates/.env.j2
    dest: "{{ crm_app.base_path }}/.env"
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
    mode: "0644"

- name: Template nginx host
  become: true
  template:
    src: templates/nginx.conf.j2
    dest: /etc/nginx/sites-available/001-crm.conf
    owner: "root"
    group: "root"
    mode: "0644"

- name: Enable nginx host
  become: true
  ansible.builtin.file:
    src: /etc/nginx/sites-available/001-crm.conf
    dest: /etc/nginx/sites-enabled/001-crm.conf
    owner: root
    group: root
    state: link

- name: Add domain to certificate to be generated
  set_fact:
    certbot_certs: '{{ certbot_certs + [ { "domains": [crm_app.domain] } ] }}'

- name: Setup cronjob
  ansible.builtin.cron:
    name: "CRM tasks"
    minute: "0"
    hour: "*"
    job: "cd {{ crm_app.base_path }} && /usr/local/bin/docker-compose run --rm crm php artisan schedule:run && curl -fsS --retry 5 -o /dev/null https://hc-ping.com/{{ crm_app.health_check_uuid }}"
